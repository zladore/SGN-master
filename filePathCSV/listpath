import os
import pandas as pd

def list_directory_contents_recursive(directory_path, max_depth=None, current_depth=0):
    """
    é€’å½’åˆ—å‡ºæŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰å­æ–‡ä»¶å’Œå­æ–‡ä»¶å¤¹

    Args:
        directory_path (str): è¦æ‰«æçš„ç›®å½•è·¯å¾„
        max_depth (int): æœ€å¤§é€’å½’æ·±åº¦ï¼ŒNoneè¡¨ç¤ºæ— é™åˆ¶
        current_depth (int): å½“å‰é€’å½’æ·±åº¦ï¼ˆå†…éƒ¨ä½¿ç”¨ï¼‰
    """
    try:
        # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
        if not os.path.exists(directory_path):
            print(f"é”™è¯¯: ç›®å½• '{directory_path}' ä¸å­˜åœ¨")
            return []

        # å¦‚æœè¶…è¿‡æœ€å¤§æ·±åº¦ï¼Œåˆ™åœæ­¢é€’å½’
        if max_depth is not None and current_depth > max_depth:
            return []

        # è·å–ç›®å½•ä¸‹çš„æ‰€æœ‰ç›´æ¥å­é¡¹
        items = os.listdir(directory_path)

        # å‡†å¤‡æ•°æ®åˆ—è¡¨
        data = []

        for item in items:
            item_path = os.path.join(directory_path, item)

            # è·å–æ–‡ä»¶/æ–‡ä»¶å¤¹ä¿¡æ¯
            if os.path.isfile(item_path):
                item_type = "æ–‡ä»¶"
                size = os.path.getsize(item_path)
                extension = os.path.splitext(item)[1] or "æ— æ‰©å±•å"
                relative_path = os.path.relpath(item_path, directory_path)

                data.append({
                    "åç§°": item,
                    "ç±»å‹": item_type,
                    "å¤§å°(B)": size,
                    "æ‰©å±•å": extension,
                    "å®Œæ•´è·¯å¾„": item_path,
                    "ç›¸å¯¹è·¯å¾„": relative_path,
                    "æ·±åº¦": current_depth
                })
            else:
                # æ˜¯æ–‡ä»¶å¤¹ï¼Œå…ˆè®°å½•æ–‡ä»¶å¤¹æœ¬èº«
                item_type = "æ–‡ä»¶å¤¹"
                relative_path = os.path.relpath(item_path, directory_path)

                data.append({
                    "åç§°": item,
                    "ç±»å‹": item_type,
                    "å¤§å°(B)": "-",
                    "æ‰©å±•å": "-",
                    "å®Œæ•´è·¯å¾„": item_path,
                    "ç›¸å¯¹è·¯å¾„": relative_path,
                    "æ·±åº¦": current_depth
                })

                # é€’å½’å¤„ç†å­æ–‡ä»¶å¤¹
                sub_data = list_directory_contents_recursive(
                    item_path, max_depth, current_depth + 1)
                data.extend(sub_data)

        return data

    except PermissionError:
        print(f"è­¦å‘Š: æ²¡æœ‰æƒé™è®¿é—®ç›®å½• '{directory_path}'")
        return []
    except Exception as e:
        print(f"é”™è¯¯: {e}")
        return []

def display_directory_structure(directory_path, max_depth=None):
    """
    æ˜¾ç¤ºç›®å½•ç»“æ„

    Args:
        directory_path (str): è¦æ˜¾ç¤ºçš„ç›®å½•è·¯å¾„
        max_depth (int): æœ€å¤§æ˜¾ç¤ºæ·±åº¦
    """
    print(f"\nç›®å½• '{directory_path}' çš„å®Œæ•´ç»“æ„:")
    print("=" * 100)

    # è·å–æ‰€æœ‰æ•°æ®
    all_data = list_directory_contents_recursive(directory_path, max_depth)

    if not all_data:
        print("ç›®å½•ä¸ºç©ºæˆ–æ— æ³•è®¿é—®")
        return

    # åˆ›å»ºDataFrame
    df = pd.DataFrame(all_data)

    # æŒ‰è·¯å¾„æ’åºä»¥ä¾¿æ›´å¥½åœ°æ˜¾ç¤ºå±‚æ¬¡ç»“æ„
    df = df.sort_values("å®Œæ•´è·¯å¾„")

    # æ˜¾ç¤ºç»“æœ
    for _, row in df.iterrows():
        indent = "  " * row["æ·±åº¦"]  # æ ¹æ®æ·±åº¦ç¼©è¿›
        if row["ç±»å‹"] == "æ–‡ä»¶å¤¹":
            print(f"{indent}ğŸ“ {row['åç§°']}/")
        else:
            size_str = f"{row['å¤§å°(B)']} B" if row["å¤§å°(B)"] != "-" else "-"
            print(f"{indent}ğŸ“„ {row['åç§°']} ({size_str})")

    # ç»Ÿè®¡ä¿¡æ¯
    file_count = len([item for item in all_data if item["ç±»å‹"] == "æ–‡ä»¶"])
    dir_count = len([item for item in all_data if item["ç±»å‹"] == "æ–‡ä»¶å¤¹"])

    print("=" * 100)
    print(f"æ€»è®¡: {file_count} ä¸ªæ–‡ä»¶, {dir_count} ä¸ªæ–‡ä»¶å¤¹")

    return df

def save_to_csv(df, filename="directory_structure.csv"):
    """
    å°†ç›®å½•ç»“æ„ä¿å­˜åˆ°CSVæ–‡ä»¶

    Args:
        df: åŒ…å«ç›®å½•ç»“æ„æ•°æ®çš„DataFrame
        filename: è¾“å‡ºçš„CSVæ–‡ä»¶å
    """
    try:
        # é€‰æ‹©è¦ä¿å­˜çš„åˆ—
        output_df = df[["åç§°", "ç±»å‹", "å¤§å°(B)", "æ‰©å±•å", "å®Œæ•´è·¯å¾„", "æ·±åº¦"]].copy()
        output_df.to_csv(filename, index=False, encoding='utf-8-sig')
        print(f"\nç›®å½•ç»“æ„å·²ä¿å­˜åˆ°: {filename}")
    except Exception as e:
        print(f"ä¿å­˜CSVæ–‡ä»¶æ—¶å‡ºé”™: {e}")

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    # æŒ‡å®šè¦æ‰«æçš„ç›®å½•
    target_directory = "/home/hqu/PycharmProjects/3D-UNet/examples"

    # æ˜¾ç¤ºç›®å½•ç»“æ„ï¼ˆå¯ä»¥è®¾ç½®max_depthé™åˆ¶é€’å½’æ·±åº¦ï¼‰
    print("æ­£åœ¨æ‰«æç›®å½•ç»“æ„...")
    result_df = display_directory_structure(target_directory, max_depth=3)

    # ä¿å­˜åˆ°CSVæ–‡ä»¶
    if result_df is not None:
        save_to_csv(result_df, "examples_directory_structure.csv")

        # å¯é€‰ï¼šæ˜¾ç¤ºä¸€äº›ç»Ÿè®¡ä¿¡æ¯
        print("\næ‰©å±•åç»Ÿè®¡:")
        ext_stats = result_df[result_df["ç±»å‹"] == "æ–‡ä»¶"]["æ‰©å±•å"].value_counts()
        for ext, count in ext_stats.items():
            print(f"  {ext}: {count} ä¸ªæ–‡ä»¶")